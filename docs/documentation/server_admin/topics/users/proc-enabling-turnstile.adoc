// Module included in the following assemblies:
//
// server_admin/topics/users.adoc

[id="proc-enabling-turnstile_{context}"]
= Enabling Cloudflare Turnstile

[role="_abstract"]
{project_name} provides native support for https://www.cloudflare.com/products/turnstile/[Cloudflare Turnstile] as a CAPTCHA provider. Turnstile offers a privacy-friendly alternative to traditional CAPTCHA solutions and is particularly useful for organizations already using Cloudflare's infrastructure or those who prefer a solution that does not rely on Google services.

Turnstile can be used to protect:

* User registration
* Login forms
* Password reset flows

== Prerequisites

Before configuring Turnstile in {project_name}, you need:

* A Cloudflare account
* A Turnstile site key and secret key

== Obtaining Turnstile keys

To get your Turnstile keys:

. Log in to your https://dash.cloudflare.com/[Cloudflare account].
. Navigate to *Turnstile* in the dashboard.
. Click *Add Site*.
. Configure your site:
** *Domain*: Enter your {project_name} domain (for example, `auth.example.com`)
** *Widget Mode*: Choose based on your needs:
*** *Managed*: Visible challenge when needed (recommended)
*** *Non-interactive*: Invisible, runs in background
*** *Invisible*: Similar to reCAPTCHA v3
. Save and copy the *Site Key* and *Secret Key*.

[NOTE]
====
For development and testing, Cloudflare provides test keys that always pass validation:

* *Site Key*: `1x00000000000000000000AA`
* *Secret Key*: `1x0000000000000000000000000000000AA`

These keys should only be used in non-production environments.
====

[[procedure_turnstile_registration]]
== Protecting registration with Turnstile

To add Turnstile protection to the registration form:

.Procedure
. Navigate to the {project_name} Admin Console.
. Click *Authentication* in the menu.
. Click the *Flows* tab.
. Select *Registration* from the list.
. Click *Add execution*.
. Select *Turnstile* from the provider list.
. Set the *Turnstile* requirement to *Required*.
. Click the *gear icon* ⚙️ on the *Turnstile* row to configure it.
+
.Turnstile configuration
+
[cols="1,3"]
|===
|Setting|Description

|Turnstile Site Key
|Your Cloudflare site key (for example, `0x4AAA...`)

|Turnstile Secret
|Your Cloudflare secret key (for example, `0x4BBB...`)

|Action Name
|A meaningful identifier for this context (for example, `register`). Action names can only contain alphanumeric characters, slashes, and underscores.

|Theme
|Widget appearance: `auto` (default), `light`, or `dark`

|Size
|Widget size: `normal` (default, 300x65px), `flexible` (responsive), or `compact` (150x140px)
|===

. Click *Save*.

[[procedure_turnstile_login]]
== Protecting login with Turnstile

To add Turnstile protection to the login form:

.Procedure
. Navigate to the {project_name} Admin Console.
. Click *Authentication* in the menu.
. Click the *Flows* tab.
. Select the *Browser* flow (or create a custom flow).
. Click *Add execution*.
. Select *Username Password Form with Turnstile*.
. Set the requirement to *Required*.
. Click the *gear icon* ⚙️ and configure the settings (same as <<procedure_turnstile_registration>>).
. Set the *Action Name* to `login`.
. Click *Save*.

[[procedure_turnstile_reset]]
== Protecting password reset with Turnstile

To secure the password reset flow:

.Procedure
. Navigate to the {project_name} Admin Console.
. Click *Authentication* in the menu.
. Click the *Flows* tab.
. Select the *Reset Credentials* flow.
. Find the *Choose User* execution.
. Click the *Actions* menu and select *Delete*.
. Click *Add execution*.
. Select *Choose User with Turnstile*.
. Set the requirement to *Required*.
. Click the *gear icon* ⚙️ and configure the settings (same as <<procedure_turnstile_registration>>).
. Set the *Action Name* to `reset`.
. Click *Save*.

== Configuration options

=== Theme

Controls the visual appearance of the Turnstile widget:

* *auto* (default): Automatically matches user's system theme
* *light*: Light theme
* *dark*: Dark theme

=== Size

Controls the widget dimensions:

* *normal* (default): Standard size (300x65px)
* *flexible*: Responsive, fills container width
* *compact*: Smaller footprint (150x140px)

=== Action Name

A meaningful identifier sent to Cloudflare for analytics and security policies. Use descriptive names like:

* `login` - For login forms
* `register` - For registration forms
* `reset` - For password reset
* `profile` - For profile updates

[NOTE]
====
Action names can only contain alphanumeric characters, slashes, and underscores.
====

== Troubleshooting

=== Widget not appearing

If the Turnstile widget does not appear on the form:

* Verify the site key is correct in the configuration
* Check the browser console for JavaScript errors
* Ensure Content Security Policy allows `challenges.cloudflare.com`
* Check if ad blockers are blocking Turnstile

=== Verification always fails

If Turnstile verification consistently fails:

* Verify the secret key matches your site key
* Ensure your {project_name} domain is configured in Cloudflare
* Check that {project_name} can reach `challenges.cloudflare.com`
* If behind a proxy, ensure the correct client IP is being forwarded

=== Proxy configuration

If {project_name} is behind a reverse proxy, configure it to forward the client's real IP address using headers like:

----
X-Forwarded-For: <client-ip>
X-Real-IP: <client-ip>
----

Ensure your proxy adds these headers and {project_name} is configured to trust them.

== Comparing Turnstile with reCAPTCHA

[cols="1,2,2"]
|===
|Feature|Turnstile|reCAPTCHA

|Privacy
|Better (no Google tracking)
|Limited

|Performance
|Fast (Cloudflare CDN)
|Good

|User Experience
|Frictionless
|Can be intrusive

|Analytics
|Via Cloudflare dashboard
|Via Google dashboard

|Cost
|Free (with Cloudflare account)
|Free (with limits)
|===

== Migration from community plugins

If you are using a community Turnstile plugin, migration to the built-in provider is straightforward:

. Remove the old plugin JAR from {project_name}.
. Restart {project_name} to load the built-in providers.
. Update your authentication flows to use the new authenticators.
. Your existing configuration (keys, theme) can be reused.

[role="_additional-resources"]
.Additional resources

* https://developers.cloudflare.com/turnstile/[Cloudflare Turnstile Documentation]
* xref:proc-enabling-recaptcha_{context}[Enabling reCAPTCHA]
* For more information on authentication flows, see link:{developerguide_link}[{developerguide_name}].
